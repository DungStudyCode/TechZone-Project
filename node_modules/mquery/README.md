# mquery

`mquery` is a fluent mongodb query builder designed to run in multiple environments.

[![Build Status](https://travis-ci.org/aheckmann/mquery.svg?branch=master)](https://travis-ci.org/aheckmann/mquery)
[![NPM version](https://badge.fury.io/js/mquery.svg)](http://badge.fury.io/js/mquery)

[![npm](https://nodei.co/npm/mquery.png)](https://www.npmjs.com/package/mquery)

## Features

- fluent query builder api
- custom base query support
- MongoDB 2.4 geoJSON support
- method + option combinations validation
- node.js driver compatibility
- environment detection
- [debug](https://github.com/visionmedia/debug) support
- separated collection implementations for maximum flexibility

## Use

```js
const mongo = require('mongodb');

const client = new mongo.MongoClient(uri);
await client.connect();
// get a collection
const collection = client.collection('artists');

// pass it to the constructor
await mquery(collection).find({...});

// or pass it to the collection method
const docs = await mquery().find({...}).collection(collection);

// or better yet, create a custom query constructor that has it always set
const Artist = mquery(collection).toConstructor();
const docs = await Artist().find(...).where(...);
```

`mquery` requires a collection object to work with. In the example above we just pass the collection object created using the official [MongoDB driver](https://github.com/mongodb/node-mongodb-native).

## Fluent API

- [mquery](#mquery)
  - [Features](#features)
  - [Use](#use)
  - [Fluent API](#fluent-api)
  - [Helpers](#helpers)
    - [find()](#find)
    - [findOne()](#findone)
    - [countDocuments()](#countdocuments)
    - [estimatedDocumentCount()](#estimateddocumentcount)
    - [findOneAndUpdate()](#findoneandupdate)
        - [findOneAndUpdate() options](#findoneandupdate-options)
    - [findOneAndReplace()](#findoneandreplace)
        - [findOneAndReplace() options](#findoneandreplace-options)
    - [findOneAndRemove()](#findoneandremove)
        - [findOneAndRemove() options](#findoneandremove-options)
    - [distinct()](#distinct)
    - [updateMany()](#updatemany)
    - [updateOne()](#updateone)
    - [replaceOne()](#replaceone)
    - [deleteOne()](#deleteone)
    - [deleteMany()](#deletemany)
    - [exec()](#exec)
    - [cursor()](#cursor)
    - [stream()](#stream)
    - [all()](#all)
    - [and()](#and)
    - [box()](#box)
    - [circle()](#circle)
    - [elemMatch()](#elemmatch)
    - [equals()](#equals)
    - [eq()](#eq)
    - [exists()](#exists)
    - [geometry()](#geometry)
    - [gt()](#gt)
    - [gte()](#gte)
    - [in()](#in)
    - [intersects()](#intersects)
    - [lt()](#lt)
    - [lte()](#lte)
    - [maxDistance()](#maxdistance)
    - [mod()](#mod)
    - [ne()](#ne)
    - [nin()](#nin)
    - [nor()](#nor)
    - [near()](#near)
      - [Example](#example)
    - [or()](#or)
    - [polygon()](#polygon)
    - [regex()](#regex)
    - [select()](#select)
        - [String syntax](#string-syntax)
    - [selected()](#selected)
    - [selectedInclusively()](#selectedinclusively)
    - [selectedExclusively()](#selectedexclusively)
    - [size()](#size)
    - [slice()](#slice)
    - [within()](#within)
    - [where()](#where)
    - [$where()](#where-1)
    - [batchSize()](#batchsize)
    - [collation()](#collation)
    - [comment()](#comment)
    - [hint()](#hint)
    - [j()](#j)
    - [limit()](#limit)
    - [maxTime()](#maxtime)
    - [skip()](#skip)
    - [sort()](#sort)
    - [read()](#read)
        - [Preferences:](#preferences)
        - [Preference Tags:](#preference-tags)
    - [readConcern()](#readconcern)
        - [Read Concern Level:](#read-concern-level)
    - [writeConcern()](#writeconcern)
        - [Write Concern:](#write-concern)
    - [slaveOk()](#slaveok)
    - [tailable()](#tailable)
    - [wtimeout()](#wtimeout)
  - [Helpers](#helpers-1)
    - [collection()](#collection)
    - [then()](#then)
    - [merge(object)](#mergeobject)
    - [setOptions(options)](#setoptionsoptions)
        - [setOptions() options](#setoptions-options)
    - [setTraceFunction(func)](#settracefunctionfunc)
    - [mquery.setGlobalTraceFunction(func)](#mquerysetglobaltracefunctionfunc)
    - [mquery.canMerge(conditions)](#mquerycanmergeconditions)
  - [mquery.use$geoWithin](#mqueryusegeowithin)
  - [Custom Base Queries](#custom-base-queries)
  - [Validation](#validation)
  - [Debug support](#debug-support)
  - [General compatibility](#general-compatibility)
      - [ObjectIds](#objectids)
      - [Read Preferences](#read-preferences)
  - [Future goals](#future-goals)
  - [Installation](#installation)
  - [License](#license)

## Helpers

- [collection](#collection)
- [then](#then)
- [merge](#mergeobject)
- [setOptions](#setoptionsoptions)
- [setTraceFunction](#settracefunctionfunc)
- [mquery.setGlobalTraceFunction](#mquerysetglobaltracefunctionfunc)
- [mquery.canMerge](#mquerycanmergeconditions)
- [mquery.use$geoWithin](#mqueryusegeowithin)

### find()

Declares this query a _find_ query. Optionally pass a match clause.

```js
mquery().find()
mquery().find(match)
await mquery().find()
const docs = await mquery().find(match);
assert(Array.isArray(docs));
```

### findOne()

Declares this query a _findOne_ query. Optionally pass a match clause.

```js
mquery().findOne()
mquery().findOne(match)
await mquery().findOne()
const doc = await mquery().findOne(match);
if (doc) {
  // the document may not be found
  console.log(doc);
}
```

### countDocuments()

Declares this query a _countDocuments_ query. Optionally pass a match clause.

```js
mquery().countDocuments()
mquery().countDocuments(match)
await mquery().countDocuments()
const number = await mquery().countDocuments(match);
console.log('we found %d matching documents', number);
```

### estimatedDocumentCount()

Declares this query an _estimatedDocumentCount_ query. Gets an estimated count of documents in a collection using collection metadata.

```js
mquery().estimatedDocumentCount()
const number = await mquery().estimatedDocumentCount();
console.log('estimated documents: %d', number);
```

### findOneAndUpdate()

Declares this query a _findAndModify_ with update query. Optionally pass a match clause, update document, options.

When executed, the first matching document (if found) is modified according to the update document and passed back.

#### findOneAndUpdate() options

Options are passed to the `setOptions()` method.

- `new`: boolean - true to return the modified document rather than the original. defaults to false
- `upsert`: boolean - creates the object if it doesn't exist. defaults to false
- `sort`: if multiple docs are found by the match condition, sets the sort order to choose which doc to update

```js
query.findOneAndUpdate()
query.findOneAndUpdate(updateDocument)
query.findOneAndUpdate(match, updateDocument)
query.findOneAndUpdate(match, updateDocument, options)

// the following all execute the command
await query.findOneAndUpdate()
await query.findOneAndUpdate(updateDocument)
await query.findOneAndUpdate(match, updateDocument)
const doc = await query.findOneAndUpdate(match, updateDocument, options);
if (doc) {
  // the document may not be found
  console.log(doc);
}
```

### findOneAndReplace()

Declares this query a _findOneAndReplace_ query. Finds a matching document, replaces it with the provided replacement, and returns the found document (if any).

#### findOneAndReplace() options

Options are passed to the `setOptions()` method.

- `new`: boolean - true to return the modified document rather than the original. defaults to false
- `upsert`: boolean - creates the object if it doesn't exist. defaults to false
- `sort`: if multiple docs are found by the match condition, sets the sort order to choose which doc to replace

```js
query.findOneAndReplace()
query.findOneAndReplace(replacement)
query.findOneAndReplace(match, replacement)
query.findOneAndReplace(match, replacement, options)

// the following all execute the command
await query.findOneAndReplace()
await query.findOneAndReplace(replacement)
await query.findOneAndReplace(match, replacement)
const doc = await query.findOneAndReplace(match, replacement, options);
if (doc) {
  // the document may not be found
  console.log(doc);
}
```

### findOneAndRemove()

Declares this query a _findAndModify_ with remove query. Alias of findOneAndDelete.
Optionally pass a match clause, options.

When executed, the first matching document (if found) is modified according to the update document, removed from the collection and passed as a result.

#### findOneAndRemove() options

Options are passed to the `setOptions()` method.

- `sort`: if multiple docs are found by the condition, sets the sort order to choose which doc to modify and remove

```js
A.where().findOneAndDelete()
A.where().findOneAndRemove()
A.where().findOneAndRemove(match)
A.where().findOneAndRemove(match, options)

// the following all execute the command
await A.where().findOneAndRemove()
await A.where().findOneAndRemove(match)
const doc = await A.where().findOneAndRemove(match, options);
if (doc) {
  // the document may not be found
  console.log(doc);
}
```

### distinct()

Declares this query a _distinct_ query. Optionally pass the distinct field, a match clause.

```js
mquery().distinct()
mquery().distinct(match)
mquery().distinct(match, field)
mquery().distinct(field)

// the following all execute the command
await mquery().distinct()
await mquery().distinct(field)
await mquery().distinct(match)
const result = await mquery().distinct(match, field);
console.log(result);
```

### updateMany()

Declares this query an _updateMany_ query. Updates all documents that match `criteria`.

When executed, the first argument is the query, and the second argument is the update document.

_All paths passed that are not $atomic operations will become $set ops._

```js
mquery().updateMany({ name: /^match/ }, { field: 'value' })
await mquery().updateMany({ name: /^match/ }, { field: 'value' })
await mquery().where({ name: /^match/ }).updateMany({ field: 'value' })
```

### updateOne()

Declares this query an _updateOne_ query. Updates only the first document that matches `criteria`.

When executed, the first argument is the query, and the second argument is the update document.

_All paths passed that are not $atomic operations will become $set ops._

```js
mquery().updateOne({ name: 'match' }, { field: 'value' })
await mquery().updateOne({ name: 'match' }, { field: 'value' })
await mquery().where({ name: 'match' }).updateOne({ field: 'value' })
```

### replaceOne()

Declares this query a _replaceOne_ query. Replaces the first document that matches `criteria` with the provided replacement